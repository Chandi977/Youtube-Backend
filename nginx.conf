worker_processes auto;

events {
    worker_connections 1024;
}

# RTMP configuration
rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        # Live streaming application
        application live {
            live on;
            record off; # No recording, just live streaming

            # Enable HLS for browser playback
            hls on;
            hls_path /tmp/hls; # Directory to store HLS files
            hls_fragment 3s;
            hls_playlist_length 60s;
        }
    }
}

# HTTP configuration
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    server {
        listen 80;

        # Proxy API and Socket.IO requests to the Node.js app
        location / {
            proxy_pass http://app:8000; # 'app' is the service name in docker-compose
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # Serve HLS files for playback
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /tmp;
            add_header Cache-Control no-cache;
            add_header 'Access-Control-Allow-Origin' '*' always; # CORS for players
        }
    }
}